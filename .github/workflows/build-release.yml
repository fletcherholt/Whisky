name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-14
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '15.2'
    
    - name: Remove SwiftLint Build Phase
      run: |
        # Modify project to remove SwiftLint build phase
        sed -i '' '/SwiftLint/d' Whisky.xcodeproj/project.pbxproj || true
        # Also disable the script phase by removing shellScript content for SwiftLint
        sed -i '' 's/swiftlint/echo "Skipping lint"/g' Whisky.xcodeproj/project.pbxproj || true
    
    - name: Build Whisky
      run: |
        set -e
        xcodebuild -project Whisky.xcodeproj \
          -scheme Whisky \
          -configuration Release \
          -derivedDataPath build \
          -destination 'platform=macOS,arch=arm64' \
          CODE_SIGN_IDENTITY="-" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO \
          ONLY_ACTIVE_ARCH=NO \
          build 2>&1 | tee build.log
          
    - name: Upload Build Log on Failure
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: build-log
        path: build.log
    
    - name: Find and Prepare App
      run: |
        find build -name "Whisky.app" -type d
        mkdir -p dist
        cp -R build/Build/Products/Release/Whisky.app dist/ || \
        cp -R "$(find build -name 'Whisky.app' -type d | head -1)" dist/
        ls -la dist/
        
    - name: Create DMG
      run: |
        brew install create-dmg || true
        
        # Try create-dmg first
        create-dmg \
          --volname "Whisky" \
          --window-pos 200 120 \
          --window-size 600 400 \
          --icon-size 100 \
          --icon "Whisky.app" 150 185 \
          --hide-extension "Whisky.app" \
          --app-drop-link 450 185 \
          "Whisky.dmg" \
          "dist/" || \
        hdiutil create -volname "Whisky" -srcfolder dist -ov -format UDZO "Whisky.dmg"
        
        ls -la *.dmg
    
    - name: Upload DMG Artifact
      uses: actions/upload-artifact@v4
      with:
        name: Whisky-${{ github.ref_name || 'build' }}
        path: "*.dmg"
        retention-days: 90
    
    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: "*.dmg"
        draft: false
        prerelease: false
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
